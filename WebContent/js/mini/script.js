var Renderer=function(settings){function renderContentArray(a,b,c){for(var d="",e=0;e<a.length;e++)d+=renderContent(a[e],b,c);return d}function renderContent(a,b,c){var d=$("#"+b),e=d.html(),f=e.match(/\{content.*?\}/g);f=f?f:[];for(var g=0;g<f.length;g++){var h=f[g].substring(1,f[g].length-1),i=extractContent(a,h);e=e.replace(f[g],i)}var j=e.match(/@@\w+\(content.*?\)/g);j=j?j:[];for(var k=0;k<j.length;k++){var l=executeDirectiveCommand(j[k],a);e=e.replace(j[k],l||"")}return e}function executeDirectiveCommand(a,b){var c=a.substring(DIRECTIVE_PREFIX.length,a.indexOf("(")),d=a.substring(a.indexOf("(")+1,a.length-1),e=directives[c],f=null;return e?f=e(d,b):console.log('Error: parsing directive command "'+a+'" .Directive with name "'+c+'" not found.'),f}function extractContent(a,b){for(var c=a,d=b.split("."),e=d[0],f=1;f<d.length;f++){if(e+="."+d[f],"undefined"==typeof c[d[f]]){c="";var g=a?JSON.stringify(a):"";g.length>30&&(g=g.substring(0,30)+"..."),console.error('path : "'+d[f]+'" of "'+e+'" is undefined, in content "'+g+'".');break}c=isRange(d[f])?getRange(c,d[f]):c[d[f]]}return c}function isRange(a){var b=a.match(/\[[0-9\-]+]/),c=null!==b&&b.length>0;return c}function getRange(a,b){var c=b.split("[")[0],d=a[c];if(d instanceof Array){for(var e=b.substring(b.indexOf("[")+1,b.length-1),f=e.split("-"),g=0;g<f.length;g++)if(f[g]=parseInt(f[g]),isNaN(f[g]))switch(parseInt(g)){case 0:f[g]=0;break;case 1:f[g]=d.length-1}d=1===f.length?d[f[g]]:d.slice(f[0],f[1]+1)}return d}var DIRECTIVE_PREFIX="@@",directives={};return directives.render=function(a,b){var c=a.split(","),d=c[0],e=c[1],f=null,g=extractContent(b,d);return f=g instanceof Array?renderContentArray(g,e):renderContent(g,e)},directives["if"]=function(directiveParams,content){var templateParams=directiveParams.split(","),condition=templateParams[0],trueValue=templateParams[1],falseValue=templateParams[2],result=null,conditionResult=!!eval(condition);return result=1==conditionResult?trueValue:falseValue},directives.if_render=function(a,b){var c=a.split(","),d=c[0],e=c[1],f=c[2],g=c[3],h=directives["if"]([d,f,g].join(","),b),i="";return h&&(i=directives.render([e,h].join(","),b)),i},directives.imagepath=function(a,b){var c=a.split(","),d=c[0],e=c[1],f=extractContent(b,d),g=null;return g=e?f.replace(/\/derivatives\/.+?\//,"/derivatives/"+e+"/"):f.replace(/_gen\/.+/,"")},directives.encodeURIComponent=function(a,b){var c=extractContent(b,a),d="";return"string"==typeof c&&(d=encodeURIComponent(c)),d},{render:function(a,b,c){var d="";return d+=a instanceof Array?renderContentArray(a,b,c):renderContent(a,b,c)}}},renderer=null;$(document).ready(function(){renderer=new Renderer,$(".js-widget").each(function(){var a=new Widget(this,{mapzoom:18,mapPinsPath:"images/mappins",styles:[{featureType:"administrative",elementType:"labels.text.fill",stylers:[{color:"#444444"}]},{featureType:"landscape",elementType:"all",stylers:[{color:"#f2f2f2"}]},{featureType:"poi",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"road",elementType:"all",stylers:[{saturation:-100},{lightness:45}]},{featureType:"road.highway",elementType:"all",stylers:[{visibility:"simplified"}]},{featureType:"road.arterial",elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"transit",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"water",elementType:"all",stylers:[{color:"#46bcec"},{visibility:"on"}]}]});a.init()}),$(".related").on("click",function(){$(".related").toggleClass("closerelated")})});var VehicleTypes={CAR:{name:"car",sits:5},BUS:{name:"bus",sits:50}},Vehicle=function(a){function b(a){var b=a.marker,d=f.marker.getPosition(),e=b.getPosition(),g=30,h=(d.lat()-e.lat())/g,i=(d.lng()-e.lng())/g;setTimeout(function(){c(b,d,h,i,g)},20)}function c(a,b,d,e,f){0==f?a.setMap(null):(newPos=new google.maps.LatLng(a.getPosition().lat()+d,a.getPosition().lng()+e),a.setPosition(newPos),setTimeout(function(){c(a,b,d,e,f-1)},20))}function d(){var a=f.type.name.toLowerCase(),b="regular",c=f.widget.getSettings().mapPinsPath;return c+="/"+a+"-"+b+".png"}function e(a){return f.type=VehicleTypes[a.toUpperCase()],f.marker&&f.marker.setIcon(f.getMarkerIcon()),f.type}var f=this,g=new google.maps.InfoWindow;this.id=a.id,this.type=e(a.type),this.model=a.model,this.lnglat=a.lnglat,this.polution=a.polution,this.onMyWay=a.onMyWay,this.passengers=a.passengers,this.widget=a.widget,this.marker=new google.maps.Marker({position:a.lnglat,map:a.widget.getMap(),icon:d()}),this.getMarkerIcon=function(){return d()},this.resetMarker=function(){this.marker.setOpacity(1),this.marker.setClickable(!0),this.marker.setIcon(d())},this.removeFromMap=function(){this.marker.setMap(null)},this.merge=function(a){var c=f.type.sits-f.passengers,d=Math.min(a.passengers,c);a.passengers-=d,f.passengers+=d,0==a.passengers?(b(a),f.widget.removeVehicleFromMap(a)):(a.marker.setAnimation(google.maps.Animation.BOUNCE),setTimeout(function(){a.marker.setAnimation(null)},700))},this.isOnMyWay=function(a){return this.onMyWay},this.setType=function(a){e(a)},google.maps.event.addListener(f.marker,"mouseover",function(){var a=null;a=f.widget.getCarPoolingState().active?renderer.render(f,"vehicle-carpolling-info-template"):renderer.render(f,"vehicle-info-template"),g.setContent(a),g.open(f.widget.getMap(),f.marker)}),google.maps.event.addListener(f.marker,"mouseout",function(){g.close()}),google.maps.event.addListener(f.marker,"click",function(){f.widget.getCarPoolingState().active?f.widget.addVehiclesToCarPool(f):f.widget.getCommuterSearchState()&&f.widget.addVehiclesToCommuters(f)})},Widget=function(a,b){var c=null,d={polutionHeatmap:new google.maps.visualization.HeatmapLayer({radius:70,opacity:1,gradient:["rgba(255,255,0,0)","rgba(245,226,10,0)","rgba(245,226,10,0.5)","rgba(255,110,2,0.5)","rgba(255,110,2,1)","rgba(255,110,2,1)","rgba(255,110,2,1)","rgba(185,0,0,1)","rgba(185,0,0,1)","rgba(185,0,0,1)"]})},e=[],f=a,g=b,h={active:!1,type:"car"},i=!1,j=null,k=null,l=this;return l.api={init:function(){c=new google.maps.Map(f.querySelector(".js-widget-map"),{center:this.getUserLocation(),zoom:g.mapzoom,styles:g.styles}),l.api.loadData();var a=f.querySelector(".js-heatmap-toggle");a.addEventListener("click",function(){var a=d.polutionHeatmap;a&&a.setMap(a.getMap()?null:l.api.getMap())});var b=$(f).find(".js-toggle-rebreath-menu");b.click(function(){$("#rebreath-menu").toggleClass("active")});var k=$(f).find(".js-toggle-simulate-menu");k.click(function(){$("#simulate-menu").toggleClass("active"),$("#simulate-menu").hasClass("active")?$("#select_number").show():$("#select_number").fadeOut()});var m=$(f).find(".js-car-pool-toggle");m.click(function(){h.active=!h.active,h.type="car",$(this).toggleClass("active"),h.active||(j=null)});var n=$(f).find(".js-bus-pool-toggle");n.click(function(){h.active=!h.active,h.type="bus",$(this).toggleClass("active"),h.active||(j=null)});var o=$(f).find(".js-commuter-search-toggle");o.click(function(){if(i=!i,$(this).toggleClass("active"),i)$("#commuters-search-form").show();else{$("#commuters-search-form").hide();for(var a=0;a<e.length;a++)e[a].resetMarker()}});var p=$(f).find(".js-commuter-search");p.click(function(){var a=$("#txtCommuterFrom").val(),b=$("#txtCommuterFrom").val(),c=$("#txtCommuterFrom").val();l.api.searchCommuters(a,b,c),$("#commuters-search-form").fadeOut()})},getUserLocation:function(){var a=new google.maps.LatLng(32.11896513512143,34.87266540527344);return a},addVehiclesToMap:function(a){for(var b=0;b<a.length;b++){var c=new Vehicle({id:b,type:a[b].type,model:a[b].model,lnglat:new google.maps.LatLng(a[b].coordinates[1],a[b].coordinates[0]),polution:a[b].polution,onMyWay:a[b].onMyWay,passengers:a[b].passengers,widget:this});e.push(c)}l.api.updatePolutionHeatmap(e)},removeVehicleFromMap:function(a){var b=e.indexOf(a);console.log(b),b>-1&&(e.splice(b,1),l.api.updatePolutionHeatmap(e))},addVehiclesToCarPool:function(a){j?(j.merge(a),j.passengers===j.type.sits&&(j=null,$(f).find(".js-car-pool-toggle").click())):(j=a,j.setType(h.type))},addVehiclesToCommuters:function(a){k||(k=[]),k.push(a),a.marker.setIcon(g.mapPinsPath+"/commuter.png")},updatePolutionHeatmap:function(a){for(var b=[],c=0;c<a.length;c++)b.push({location:a[c].lnglat,weight:a[c].polution});d.polutionHeatmap.setData(b)},searchCommuters:function(a,b,c){for(var d=0;d<e.length;d++)e[d].isOnMyWay()||(e[d].marker.setOpacity(.2),e[d].marker.setClickable(!1));k=null},getMap:function(){return c},getSettings:function(){return g},getCarPoolingState:function(){return h},getCommuterSearchState:function(){return i},loadData:function(){$.ajax({url:"data/points.json",success:function(a){l.api.addVehiclesToMap(a.data)}})}},l.api};