var Renderer=function(settings){function renderContentArray(a,b,c){for(var d="",e=0;e<a.length;e++)d+=renderContent(a[e],b,c);return d}function renderContent(a,b,c){var d=$("#"+b),e=d.html(),f=e.match(/\{content.*?\}/g);f=f?f:[];for(var g=0;g<f.length;g++){var h=f[g].substring(1,f[g].length-1),i=extractContent(a,h);e=e.replace(f[g],i)}var j=e.match(/@@\w+\(content.*?\)/g);j=j?j:[];for(var k=0;k<j.length;k++){var l=executeDirectiveCommand(j[k],a);e=e.replace(j[k],l||"")}return e}function executeDirectiveCommand(a,b){var c=a.substring(DIRECTIVE_PREFIX.length,a.indexOf("(")),d=a.substring(a.indexOf("(")+1,a.length-1),e=directives[c],f=null;return e?f=e(d,b):console.log('Error: parsing directive command "'+a+'" .Directive with name "'+c+'" not found.'),f}function extractContent(a,b){for(var c=a,d=b.split("."),e=d[0],f=1;f<d.length;f++){if(e+="."+d[f],"undefined"==typeof c[d[f]]){c="";var g=a?JSON.stringify(a):"";g.length>30&&(g=g.substring(0,30)+"..."),console.error('path : "'+d[f]+'" of "'+e+'" is undefined, in content "'+g+'".');break}c=isRange(d[f])?getRange(c,d[f]):c[d[f]]}return c}function isRange(a){var b=a.match(/\[[0-9\-]+]/),c=null!==b&&b.length>0;return c}function getRange(a,b){var c=b.split("[")[0],d=a[c];if(d instanceof Array){for(var e=b.substring(b.indexOf("[")+1,b.length-1),f=e.split("-"),g=0;g<f.length;g++)if(f[g]=parseInt(f[g]),isNaN(f[g]))switch(parseInt(g)){case 0:f[g]=0;break;case 1:f[g]=d.length-1}d=1===f.length?d[f[g]]:d.slice(f[0],f[1]+1)}return d}var DIRECTIVE_PREFIX="@@",directives={};return directives.render=function(a,b){var c=a.split(","),d=c[0],e=c[1],f=null,g=extractContent(b,d);return f=g instanceof Array?renderContentArray(g,e):renderContent(g,e)},directives["if"]=function(directiveParams,content){var templateParams=directiveParams.split(","),condition=templateParams[0],trueValue=templateParams[1],falseValue=templateParams[2],result=null,conditionResult=!!eval(condition);return result=1==conditionResult?trueValue:falseValue},directives.if_render=function(a,b){var c=a.split(","),d=c[0],e=c[1],f=c[2],g=c[3],h=directives["if"]([d,f,g].join(","),b),i="";return h&&(i=directives.render([e,h].join(","),b)),i},directives.imagepath=function(a,b){var c=a.split(","),d=c[0],e=c[1],f=extractContent(b,d),g=null;return g=e?f.replace(/\/derivatives\/.+?\//,"/derivatives/"+e+"/"):f.replace(/_gen\/.+/,"")},directives.encodeURIComponent=function(a,b){var c=extractContent(b,a),d="";return"string"==typeof c&&(d=encodeURIComponent(c)),d},{render:function(a,b,c){var d="";return d+=a instanceof Array?renderContentArray(a,b,c):renderContent(a,b,c)}}},renderer=null;$(document).ready(function(){renderer=new Renderer,$(".widget").each(function(){var a=new Widget(this,{mapzoom:13});a.init()})});var Vehicle=function(a){var b=this,c=null;this.type=a.type,this.model=a.model,this.lnglat=a.lnglat,this.polution=a.polution,this.isOnMyWay=a.isOnMyWay,this.passengers=a.passengers,this.sits=a.sits,this.widget=a.widget,this.marker=new google.maps.Marker({position:a.lnglat,map:a.widget.getMap()}),google.maps.event.addListener(b.marker,"click",function(){if(!c){var a=renderer.render(b,"vehicle-info-template");c=new google.maps.InfoWindow,c.setContent(a)}c.open(b.widget.getMap(),b.marker)})},Widget=function(a,b){var c=null,d={polutionHeatmap:new google.maps.visualization.HeatmapLayer({radius:70,opacity:1,gradient:["rgba(255,255,0,0)","rgba(245,226,10,0)","rgba(245,226,10,0.5)","rgba(255,110,2,0.5)","rgba(255,110,2,1)","rgba(255,110,2,1)","rgba(255,110,2,1)","rgba(185,0,0,1)","rgba(185,0,0,1)","rgba(185,0,0,1)"]})},e=[],f=a,g=b,h=this;return h.api={init:function(){c=new google.maps.Map(f.querySelector(".widget__map"),{center:this.getUserLocation(),zoom:g.mapzoom}),h.api.loadData();var a=f.querySelector(".widget__heatmap-toggle");a.addEventListener("click",function(){var a=d.polutionHeatmap;a&&a.setMap(a.getMap()?null:h.api.getMap())})},getUserLocation:function(){var a=new google.maps.LatLng(32.11896513512143,34.87266540527344);return a},addVehiclesToMap:function(a){for(var b=0;b<a.length;b++){var c=new Vehicle({type:a[b].type,model:a[b].model,lnglat:new google.maps.LatLng(a[b].coordinates[1],a[b].coordinates[0]),polution:a[b].polution,isOnMyWay:a[b].isOnMyWay,passengers:a[b].passengers,sits:a[b].sits,widget:this});e.push(c)}h.api.updatePolutionHeatmap(e)},updatePolutionHeatmap:function(a){for(var b=[],c=0;c<a.length;c++)b.push({location:a[c].lnglat,weight:a[c].polution});d.polutionHeatmap.setData(b)},getMap:function(){return c},loadData:function(){$.ajax({url:"data/points.json",success:function(a){h.api.addVehiclesToMap(a.data)}})}},h.api};